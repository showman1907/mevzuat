<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Mevzuat Otomatik PDF Listeleme</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f0f2f5;
    }
    h1 {
      color: #003366;
    }
    .controls {
      margin-bottom: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .controls label {
      font-weight: bold;
      margin-right: 5px;
    }
    .controls select,
    .controls input {
      padding: 5px;
      font-size: 1rem;
    }
    .category-section {
      background: #fff;
      margin-bottom: 30px;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .subcategory {
      margin-left: 20px;
      margin-bottom: 10px;
    }
    .subcategory h3 {
      margin-bottom: 5px;
      color: #007bff;
    }
    .pdf-link {
      display: block;
      margin: 4px 0;
      text-decoration: none;
      color: #333;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }
    .pdf-link:hover {
      background: #eef;
    }
  </style>
</head>
<body>
  <h1>Tapu ve Kadastro Mevzuat Sistemi</h1>
  <p>Bu sayfa, GitHub’da <code>showman1907/mevzuat</code> reposundaki PDF’leri otomatik olarak listeler.</p>

  <div class="controls">
    <label for="yearFilter">Yıl Filtrele:</label>
    <select id="yearFilter">
      <option value="">Tümü</option>
    </select>

    <label for="searchInput">Ara:</label>
    <input type="text" id="searchInput" placeholder="Genelge başlığı veya dosya adı..." />
  </div>

  <div id="app"></div>

  <script>
    const owner = "showman1907";
    const repo  = "mevzuat";
    const mainFolders = ["TAPU", "KADASTRO"];
    let allPdfs = []; // Tüm PDF kayıtları

    async function getContents(path) {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const resp = await fetch(url);
      if (!resp.ok) return [];
      return resp.json();
    }

    function extractYear(name) {
      const m = name.match(/^(\d{4})/);
      return m ? m[1] : "";
    }

    function populateYearFilter() {
      const select = document.getElementById("yearFilter");
      const years = Array.from(new Set(allPdfs.map(p => p.year).filter(y => y)))
                         .sort((a,b)=>b-a);
      years.forEach(y => {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y;
        select.appendChild(opt);
      });
    }

    function renderList() {
      const container = document.getElementById("app");
      container.innerHTML = "";

      const yearSel = document.getElementById("yearFilter").value;
      const searchTerm = document.getElementById("searchInput").value.toLowerCase();

      mainFolders.forEach(folder => {
        const section = document.createElement("div");
        section.className = "category-section";
        section.innerHTML = `<h2>${folder}</h2>`;
        container.appendChild(section);

        // Alt klasörlere göre grupla
        const subs = [...new Set(
          allPdfs
            .filter(p => p.folder === folder)
            .filter(p => (!yearSel || p.year === yearSel))
            .filter(p => p.name.toLowerCase().includes(searchTerm) ||
                         p.subfolder.toLowerCase().includes(searchTerm) )
            .map(p => p.subfolder)
        )];

        subs.forEach(sub => {
          const subDiv = document.createElement("div");
          subDiv.className = "subcategory";
          subDiv.innerHTML = `<h3>${sub}</h3>`;
          section.appendChild(subDiv);

          allPdfs
            .filter(p => p.folder === folder && p.subfolder === sub)
            .filter(p => (!yearSel || p.year === yearSel))
            .filter(p => p.name.toLowerCase().includes(searchTerm) ||
                         p.subfolder.toLowerCase().includes(searchTerm))
            .forEach(p => {
              const a = document.createElement("a");
              a.href = p.url;
              a.target = "_blank";
              a.className = "pdf-link";
              a.textContent = `${p.year ? "["+p.year+"] " : ""}${p.name}`;
              subDiv.appendChild(a);
            });
        });
      });
    }

    async function loadAll() {
      for (let folder of mainFolders) {
        const contents = await getContents(folder);
        const dirs = contents.filter(i=>i.type==="dir").map(i=>i.name);

        for (let sub of dirs) {
          const items = await getContents(`${folder}/${sub}`);
          items
            .filter(i=>i.type==="file" && i.name.toLowerCase().endsWith(".pdf"))
            .forEach(i => {
              const yr = extractYear(i.name);
              allPdfs.push({
                folder, subfolder: sub,
                name: i.name,
                url: i.download_url,
                year: yr
              });
            });
        }
      }
      populateYearFilter();
      renderList();
    }

    document.getElementById("yearFilter").addEventListener("change", renderList);
    document.getElementById("searchInput").addEventListener("input", renderList);

    loadAll();
  </script>
</body>
</html>
